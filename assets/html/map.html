<!DOCTYPE html>
<html>

<head>
    <title>Leaflet Map</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        html,
        body {
            margin: 0;
            padding: 0;
        }

        #map {
            width: 100vw;
            height: 100vh;
        }

        /* Custom Green Popup Styles */
        .leaflet-popup-content-wrapper {
            background: #2d5016;
            color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 3px 14px rgba(0, 0, 0, 0.4);
        }

        .leaflet-popup-content {
            margin: 15px;
            line-height: 1.4;
            min-width: 200px;
        }

        .leaflet-popup-tip-container {
            width: 40px;
            height: 20px;
        }

        .leaflet-popup-tip {
            background: #2d5016;
        }
        
        .popup-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 8px;
            text-align: center;
        }

        .popup-description {
            font-size: 12px;
            margin-bottom: 10px;
            line-height: 1.6;
        }

        .popup-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            gap: 8px;
        }

        .popup-button {
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            flex: 1;
            text-align: center;
            transition: opacity 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .popup-button .material-icons {
            font-size: 18px;
        }

        .popup-button:hover {
            opacity: 0.8;
        }

        .edit-button {
            background-color: #4CAF50;
        }

        .delete-button {
            background-color: #f44336;
        }

        a.leaflet-popup-close-button {
            color: #ffffff !important;
        }
        
        .popup-image {
            width: 100%;
            max-width: 250px;
            height: auto;
            max-height: 200px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 10px;
            display: block;
        }

        .popup-no-image {
            background: rgba(255, 255, 255, 0.1);
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            margin-bottom: 10px;
            font-size: 11px;
            color: rgba(255, 255, 255, 0.6);
        }

    </style>
</head>

<body>
    <div id="map"></div>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    
    <script>
        const map = L.map('map').setView([-7.7956, 110.3695], 13);
        const markersLayer = L.layerGroup().addTo(map);

        // Define a custom yellow icon
        var yellowIcon = new L.Icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-yellow.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41],
            className: 'material-icon-green'
        });

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // Function to render points on the map
        function renderPoints(points) {
            markersLayer.clearLayers();
            
            if (points && Array.isArray(points)) {
                points.forEach((point) => {
                    if (point.coordinates) {
                        const coords = point.coordinates.split(",").map(parseFloat);
                        if (isNaN(coords[0]) || isNaN(coords[1])) return;

                        const marker = L.marker(coords, { icon: yellowIcon });
                        marker.addTo(markersLayer);
                        
                        // Escape special characters for JSON in HTML
                        const pointDataStr = JSON.stringify(point).replace(/'/g, "&#39;").replace(/"/g, "&quot;");
                        
                        // Build image HTML
                        let imageHtml = '';
                        if (point.photoUrl && point.photoUrl.trim() !== '') {
                            imageHtml = `<img src="${point.photoUrl}" class="popup-image" alt="Point Photo" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';" />
                                        <div class="popup-no-image" style="display:none;">ðŸ“· Foto tidak dapat dimuat</div>`;
                        } else {
                            imageHtml = '<div class="popup-no-image">ðŸ“· Tidak ada foto</div>';
                        }
                        
                        const popupContent = `
                            <div class="popup-title">${point.name || 'Tidak ada nama'}</div>
                            ${imageHtml}
                            <div class="popup-description">
                                ðŸ“… ${point.date || 'Tanggal tidak tersedia'}<br/>
                                ðŸŽ¯ Akurasi: ${point.accuration || 'N/A'}
                            </div>
                            <div class="popup-actions">
                                <button class="popup-button edit-button" onclick='editPoint(${pointDataStr})'>
                                    <i class="material-icons">edit</i>
                                    <span>Edit</span>
                                </button>
                                <button class="popup-button delete-button" onclick='deletePoint(${pointDataStr})'>
                                    <i class="material-icons">delete</i>
                                    <span>Hapus</span>
                                </button>
                            </div>
                        `;
                        
                        marker.bindPopup(popupContent, {
                            maxWidth: 300,
                            minWidth: 200
                        });
                    }
                });
            }
        }

        // Function to send "edit" message to React Native
        function editPoint(point) {
            if (window.ReactNativeWebView) {
                window.ReactNativeWebView.postMessage(JSON.stringify({ action: 'edit', data: point }));
            }
        }

        // Function to send "delete" message to React Native
        function deletePoint(point) {
            if (window.ReactNativeWebView) {
                window.ReactNativeWebView.postMessage(JSON.stringify({ action: 'delete', data: point }));
            }
        }

        // Handle messages from React Native
        document.addEventListener('message', (event) => {
            try {
                const message = JSON.parse(event.data);
                const { action, data } = message;
                
                if (action === 'loadPoints') {
                    renderPoints(data);
                }

            } catch (error) {
                console.error('Error handling message from React Native:', error);
            }
        });
    </script>
</body>

</html>